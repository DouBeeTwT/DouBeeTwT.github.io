---
title: 一种基于隐马尔科夫模型的股价涨跌区间预测方法
description: 股票作为现代经济中一种重要的融资手段正在被广泛的使用在商业以及个人投资领域。对于股票的甄别选自也有种类繁多的体系与理论。以前重要的两个派别是技术指标派和K线派，但随着近年来计算机的普及与性能的提升，通过编制特定的程序控制买卖时间点的量化交易派逐渐兴起。本文将以隐马尔科夫模型为判别模型，考察其在应用与股票投资上的适合性。
categories:
 - 论文
tags: HMM python R 
---

## 第一章 量化交易与隐马尔科夫模型

### 量化交易

股票作为现代经济中一种重要的融资手段正在被广泛的使用在商业以及个人投资领域。对于股票的甄别选自也有种类繁多的体系与理论。以前重要的两个派别是技术指标派和K线派，但随着近年来计算机的普及与性能的提升，通过编制特定的程序控制买卖时间点的量化投资派逐渐兴起。

#### 量化交易的概念

量化交易是指以先进的数学模型替代人为的主观判断，利用计算机技术从庞大的历史数据中海选能带来超额收益的多种“大概率”事件以制定策略，极大地减少了投资者情绪波动的影响，避免在市场极度狂热或悲观的情况下作出非理性的投资决策。

#### 量化交易的特点

定量投资和传统的定性投资本质上来说是相同的，二者都是基于市场非有效或弱有效的理论基础。两者的区别在于定量投资管理是“定性思想的量化应用”，更加强调数据。量化交易具有以下几个方面的特点：

1. 纪律性。根据模型的运行结果进行决策，而不是凭感觉。纪律性既可以克制人性中贪婪、恐惧和侥幸心理等弱点，也可以克服认知偏差，且可跟踪。
2. 系统性。具体表现为“三多”。一是多层次，包括在大类资产配置、行业选择、精选具体资产三个层次上都有模型；二是多角度，定量投资的核心思想包括宏观周期、市场结构、估值、成长、盈利质量、分析师盈利预测、市场情绪等多个角度；三是多数据，即对海量数据的处理。
3. 套利思想。定量投资通过全面、系统性的扫描捕捉错误定价、错误估值带来的机会，从而发现估值洼地，并通过买入低估资产、卖出高估资产而获利。
4. 概率取胜。一是定量投资不断从历史数据中挖掘有望重复的规律并加以利用；二是依靠组合资产取胜，而不是单个资产取胜。

#### 量化交易的应用——算法交易

算法交易又称自动交易、黑盒交易或机器交易，是指通过设计算法，利用计算机程序发出交易指令的方法。在交易中，程序可以决定的范围包括交易时间的选择、交易的价格，甚至包括最后需要成交的资产数量。算法交易的主要类型有: 

1. 被动型算法交易，也称结构型算法交易。该交易算法除利用历史数据估计交易模型的关键参数外，不会根据市场的状况主动选择交易时机和交易的数量，而是按照一个既定的交易方针进行交易。该策略的的核心是减少滑价（目标价与实际成交均价的差）。被动型算法交易最成熟，使用也最为广泛，如在国际市场上使用最多的成交加权平均价格（VWAP）、时间加权平均价格（TWAP）等都属于被动型算法交易。
2. 主动型算法交易，也称机会型算法交易。这类交易算法根据市场的状况作出实时的决策，判断是否交易、交易的数量、交易的价格等。主动型交易算法除了努力减少滑价以外，把关注的重点逐渐转向了价格趋势预测上。
3. 综合型算法交易，该交易是前两者的结合。这类算法常见的方式是先把交易指令拆开，分布到若干个时间段内，每个时间段内具体如何交易由主动型交易算法进行判断。两者结合可达到单纯一种算法无法达到的效果。

#### 小结
对于股票来说，一只好的股票由于不当的买入卖出时机亦有可能造成投资的失败或至少是盈利的减少。所以本文中并未按照量化交易的最基本出发点选股着手，而是着眼于对一只已选定的股票，什么样的买入与卖出时机能保证自己的盈利。即在本文中我们利用隐马尔科夫模型去模拟股价的一种潜在的涨跌区间交替关系，依此为根据决定股票的买入与卖出，控制了量化交易的时间选择，避免了人为选择的“追涨杀跌”等不理性行为，提高了风险规避能力，增加了机会找寻概率。同时，这样的控制存在着更加普适的意义，即无论什么样的股票都能增加盈利或者减少损失。

### 隐马尔科夫模型
过程或（系统）在时刻t0所处的状态为已知的条件下，过程在时刻t>t0所处状态的条件分布与过程在时刻t0之前所处的状态无关的特性称为马尔可夫性，而具有马尔可夫性的随机过程称为马尔可夫过程。

$P{X(t_n)<=x_n|X(t_i)=x_i}=P{X(t_n)<=x_n|X(t_n-1)=x_n-1}$ (1)

在简单的马尔可夫模型（如马尔可夫链），所述状态是直接可见的观察者，因此状态转移概率是唯一的参数。在隐马尔可夫模型中，状态是不直接可见的，但输出依赖于该状态下，是可见的。每个状态通过可能的输出记号有了可能的概率分布。因此，通过一个HMM产生标记序列提供了有关状态的一些序列的信息。注意，“隐藏”指的是，该模型经其传递的状态序列，而不是模型的参数；即使这些参数是精确已知的，我们仍把该模型称为一个“隐藏”的马尔可夫模型。隐马尔可夫模型以它在时间上的模式识别所知，如语音，手写，手势识别，词类的标记，乐谱，局部放电和生物信息学应用。基于隐马尔科夫模型存在三个问题与对应的算法：
#### 评估问题： 前向算法
#### 解码问题： Viterbi算法
#### 学习问题： Baum-Welch算法

## 第二章 实验结果与讨论

本文通过隐马尔可夫模型，对输入的股票显式序列进行建模从而得到推测的隐式序列。对于股票的显式序列有两种来源：一是通过股价的布朗运动规律，自动随机生成人造股价波动。第二是从[雅虎财经](https://hk.finance.yahoo.com/)上下载上证50的股票从上市到2018年4月25日的所有股价数据。以此为两种原始数据来源构建统一格式的股价显式序列，即如果当日收盘价大于开盘价则记录为“R”(red),反之记录为“G”(green)。

> 若收盘价-开盘价: +0.13 +0.21 -0.43 +0.54 -0.22 -0.23 -0.11 +0.02 -0.05
> 
> 记录的显式序列 RRGRGGGRG

### 模拟股价测试

#### 基于几何布朗运动的人工股价随机函数
对于人工股价随机函数，这里用到几何布朗运动ln(S(y+t)/S(y))~N(mu,sigma)，此处我们取时间t为一天，表示连续两天股价之比的对数值满足高斯分布。于是所得代码如下：

```python
import matplotlib.pyplot as plt
import numpy as np

def Price(f=0.02,u=0,t=200):
    v = f*np.random.randn(t)+u
    P=[1]
    for i in range (t-1):
        P.append(P[i]*np.exp(v[i]))
    plt.plot(P)
    plt.show()
    return P,v

#价格水平通道曲线
Price()

#价格上升通道曲线
Price(u=0.01)

#价格下降通道曲线
Price(u=-0.01)

```

![图片1](/source/HMM/Price.png)

函数Price(f,u,t)中的f表示波动程度，默认为2%;u表示偏移量即表征了服从的高斯分布的均值大小,默认为0;t表示需要生成的股价天数，默认200天。依照编程函数生成的股价曲线如**图1**，从图中我们也可以发现其走势确实如我们所见的真实股票一样存在着波动，且随着u值的改变，改变了股价的走势。(出于美观性考虑此图由Python运行后的数据使用R中的ggplot做图)

#### 隐马尔可夫模型简单测试

```python

```

![图片2](/source/HMM/test1.png)

通过隐马尔可夫模型对我们上一步所说的基于几何布朗运动的人工股价随机函数生成的显式序列进行拟合，Viterbi算法推测所得的最大概率隐式序列可视化表示如上图。从图中我们可以发现,通过隐马尔可夫模型处理后的涨跌区间有着较好的拟合。在70-170天与650-800天这两段明显的下跌区间中甚至依旧可以找到一小段的回升，220-300天的震荡区间中也可以发现明显的上涨下跌交替出现的情况。

#### 小结
通过对人工生成的股价测试结果来看，隐马尔可夫模型存在这一定的可行性。对于一段不明确上涨或下跌趋势的波动区间能有效的识别出其隐藏的上涨下跌区间。在明显的下跌区间中能依旧能有效的识别出一小段上涨区间，且一段上下波动的区间中也会灵活的识别转换隐式状态。这以简单的测试说明了隐马尔可夫模型对于股价变化的识别有效，这为我们下一步继续对上证50真实数据进行进一步测试提供了保障。

### 上证50真实数据回测
